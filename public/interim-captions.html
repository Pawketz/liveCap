<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interim Captions Display</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cherry+Cream+Soda&family=Life+Savers:wght@400;700;800&display=swap');
        .cherry-cream-soda-regular {
            font-family: "Life", system-ui;
            font-weight: 400;
            font-style: normal;
        }
    </style>
    <style>
        html {
            font-family: 'Life Savers', system-ui;
            background: transparent !important;
            background-color: rgba(0, 0, 0, 0) !important;
        }
        body {
            margin: 0;
            padding: 0;
            background: transparent !important;
            background-color: rgba(0, 0, 0, 0) !important;
            overflow: hidden;
            height: 100vh;
            display: flex;
            align-items: flex-end;
            justify-content: center;
        }
        
        .captions-container {
            width: fit-content;
            max-width: 900px;
            padding: 20px;
            margin: 0 auto;
            box-sizing: border-box;
            background: transparent !important;
        }
        
        .caption-line {
            background: none;
            max-height: 100px;
            color: white;
            padding: 12px 20px;
            margin: 5px 0;
            border-radius: 25px;
            font-size: 30px;
            font-weight: 600;
            text-align: center;
            line-height: 1.4;
            animation: slideUp 0.3s ease-out;
            border: 2px solid rgba(255, 255, 255, 0.8);
            text-shadow: 
                2px 2px 0px #000,
                -2px -2px 0px #000,
                2px -2px 0px #000,
                -2px 2px 0px #000,
                0px 2px 0px #000,
                2px 0px 0px #000,
                0px -2px 0px #000,
                -2px 0px 0px #000,
                1px 1px 2px rgba(0,0,0,0.8);
        }
        
        .caption-line.interim {
            background: rgba(182, 155, 219, 0.6);
            max-height: 100px;
            border: 2px solid rgba(182, 155, 219, 0.795);
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Fade out old captions */
        .caption-line.old {
            animation: fadeOut 1s ease-out forwards;
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                /* transform: translateY(-20px); */
            }
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .caption-line {
                font-size: 20px;
                padding: 10px 15px;
            }
        }
        
        @media (max-width: 480px) {
            .caption-line {
                font-size: 18px;
                padding: 8px 12px;
            }
        }
        
        /* OBS-friendly styling */
        .captions-container {
            position: relative;
            z-index: 1000;
        }
        
        /* OBS Browser Source Transparency Fix */
        html, body {
            background: rgba(0, 0, 0, 0) !important;
            background-color: rgba(0, 0, 0, 0) !important;
        }
        
        /* Ensure OBS detects transparency correctly */
        .captions-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0);
            pointer-events: none;
            z-index: -1;
        }
    </style>
</head>
<body>
    <div class="captions-container" id="captionsContainer">
        <!-- Interim captions will be dynamically added here -->
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const captionsContainer = document.getElementById('captionsContainer');
        
        // OBS Browser Source Transparency Fix
        function forceOBSTransparency() {
            document.documentElement.style.backgroundColor = 'rgba(0, 0, 0, 0)';
            document.body.style.backgroundColor = 'rgba(0, 0, 0, 0)';
            
            // Force CSS to be applied
            document.documentElement.style.background = 'transparent';
            document.body.style.background = 'transparent';
        }
        
        // Apply transparency fix immediately and on load
        forceOBSTransparency();
        window.addEventListener('load', forceOBSTransparency);
        
        let currentInterimElement = null;
        const INTERIM_FADE_TIMEOUT = 3000; // 3 seconds after no updates
        
        socket.on('caption-update', (data) => {
            console.log('Received caption:', data);
            
            // Only show interim captions (ignore final captions)
            if (!data.isFinal && data.text && data.text.trim()) {
                displayInterimCaption(data.text);
            } else if (data.isFinal) {
                console.log('Ignoring final caption:', data.text);
                // Start fade timer when final caption comes in
                startFadeTimer();
            }
        });
        
        socket.on('captions-cleared', () => {
            clearAllCaptions();
        });
        
        function displayInterimCaption(text) {
            console.log('Displaying interim caption:', text);
            
            // Clear any existing fade timer
            if (currentInterimElement && currentInterimElement.fadeTimer) {
                clearTimeout(currentInterimElement.fadeTimer);
            }
            
            // Update existing interim caption or create new one
            if (currentInterimElement) {
                currentInterimElement.textContent = text;
                // Remove any existing fade class
                currentInterimElement.classList.remove('old');
            } else {
                currentInterimElement = createInterimCaptionElement(text);
                captionsContainer.appendChild(currentInterimElement);
            }
            
            // Set a timer to fade out the caption after 3 seconds of no updates
            startFadeTimer();
        }
        
        function createInterimCaptionElement(text) {
            const element = document.createElement('div');
            element.className = 'caption-line interim';
            element.textContent = text;
            return element;
        }
        
        function startFadeTimer() {
            if (currentInterimElement) {
                // Clear existing timer
                if (currentInterimElement.fadeTimer) {
                    clearTimeout(currentInterimElement.fadeTimer);
                }
                
                // Set new timer
                currentInterimElement.fadeTimer = setTimeout(() => {
                    console.log('Starting fade out after 3 seconds');
                    fadeOutInterimCaption();
                }, INTERIM_FADE_TIMEOUT);
            }
        }
        
        function fadeOutInterimCaption() {
            console.log('fadeOutInterimCaption called');
            if (currentInterimElement && currentInterimElement.parentNode) {
                console.log('Adding fade out class');
                currentInterimElement.classList.add('old');
                // Remove the element after fade animation completes
                setTimeout(() => {
                    console.log('Removing element after fade animation');
                    if (currentInterimElement && currentInterimElement.parentNode) {
                        currentInterimElement.remove();
                        currentInterimElement = null;
                    }
                }, 2000); // Match the fadeOut animation duration
            }
        }
        
        function clearInterimCaption() {
            if (currentInterimElement) {
                if (currentInterimElement.fadeTimer) {
                    clearTimeout(currentInterimElement.fadeTimer);
                }
                if (currentInterimElement.parentNode) {
                    currentInterimElement.remove();
                }
                currentInterimElement = null;
            }
        }
        
        function clearAllCaptions() {
            captionsContainer.innerHTML = '';
            currentInterimElement = null;
        }
        
        // Connection status handling
        socket.on('connect', () => {
            console.log('Connected to server - Interim Captions Mode');
        });
        
        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });
        
        // Add a small indicator that this is interim mode
        window.addEventListener('load', () => {
            const indicator = document.createElement('div');
            indicator.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(255, 255, 0, 0.8);
                color: black;
                padding: 2px 6px;
                border-radius: 3px;
                font-size: 10px;
                z-index: 9999;
                font-weight: bold;
            `;
            indicator.textContent = 'INTERIM';
            indicator.title = 'Interim Captions Only';
            document.body.appendChild(indicator);
            
            // Remove indicator after 5 seconds
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 5000);
        });
    </script>
</body>
</html>
